{% extends "base.html" %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Lista de Pedidos</h2>
    {% if session["rol"] == "jefe" %}
        <a href="{{ url_for('pedidos.crear_pedido') }}" class="btn btn-primary">
            Nuevo Pedido
        </a>
    {% endif %}
</div>
{% if session["rol"] == "empleado" %}
        <p>Aquí se listarán tus pedidos...</p>
{% endif %}

<form method="GET" action="{{ url_for('pedidos.listar_pedidos') }}" style="margin-bottom:20px;">

    <input type="text" name="busqueda" placeholder="Buscar cliente..."
           value="{{ busqueda }}">

    <select name="estado">
        <option value="">Todos los estados</option>
        <option value="pendiente" {% if estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
        <option value="en_proceso" {% if estado == 'en_proceso' %}selected{% endif %}>En proceso</option>
        <option value="terminado" {% if estado == 'terminado' %}selected{% endif %}>Terminado</option>
    </select>

    <button type="submit">Filtrar</button>
</form>


<table class="table table-striped table-hover">
    <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Estado</th>
            <th>Responsable</th>
            <th>Fecha Entrega</th>
            <th>Saldo</th>
            <th>Acciones</th>

        </tr>
    </thead>
    <tbody>
        {% for pedido in pedidos %}
        <tr>
            <td>{{ pedido.id }}</td>
            <td>{{ pedido.cliente_nombre }}</td>
            <td>
                {% if pedido.estado == "terminado" %}
                    <strong style="color: green;">Terminado</strong>
                {% else %}
                    <form method="POST" action="{{ url_for('pedidos.actualizar_estado', pedido_id=pedido.id) }}">
                        <select name="estado">
                            <option value="pendiente" {% if pedido.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                            <option value="en_proceso" {% if pedido.estado == 'en_proceso' %}selected{% endif %}>En proceso</option>
                            <option value="terminado" {% if pedido.estado == 'terminado' %}selected{% endif %}>Terminado</option>
                        </select>
                        <button type="submit">Actualizar</button>
                    </form>
                {% endif %}
            </td>
            <td>
                {% if pedido.responsable_nombre %}
                    {{ pedido.responsable_nombre }}
                {% else %}
                    Sin asignar
                {% endif %}
            </td>
            <td>{{ pedido.fecha_entrega }}</td>
            <td>{{ pedido.saldo }}</td>
            <td>
                <a href="{{ url_for('pedidos.detalle_pedido', pedido_id=pedido.id) }}" class="btn btn-sm btn-info">
                    Ver
                </a>
            </td>

        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}